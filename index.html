<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KTM Serdang-Midvalley route on weekdays</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map { height: 600px; }
    </style>
</head>
<body>
    <h1>Active Trains</h1>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Vehicle IDs and Departure Times for MV and Serdang stations
        const MVVehicleId = ["weekday_2003", "weekday_2007", "weekday_2011", "weekday_2013", "weekday_2015", "weekday_2017", "weekday_2019", "weekday_2021", "weekday_2025", "weekday_2027", "weekday_2031", "weekday_2035", "weekday_2039", "weekday_2045", "weekday_2049", "weekday_2053", "weekday_2603", "weekday_2057", "weekday_2059", "weekday_2061", "weekday_2063", "weekday_2067", "weekday_2071"];
        const MVDepartureTime = ["05:39", "06:40", "07:35", "08:05", "08:35", "09:08", "09:35", "10:05", "10:35", "11:35", "12:40", "13:45", "14:45", "15:45", "16:45", "17:35", "NONE", "18:10", "18:40", "19:20", "20:35", "21:48", "22:48"];
        
        const SerdangVehicleId = ["weekday_2002", "weekday_2004", "weekday_2602", "weekday_2008", "weekday_2010", "weekday_2012", "weekday_2014", "weekday_2016", "weekday_2018", "weekday_2020", "weekday_2024", "weekday_2028", "weekday_2032", "weekday_2036", "weekday_2040", "weekday_2046", "weekday_2048", "weekday_2050", "weekday_2054", "weekday_2058", "weekday_2062", "weekday_2066", "weekday_2070"];
        const SerdangDepartureTime = ["06:30", "06:55", "NONE", "07:25", "07:58", "08:30", "09:02", "09:32", "10:08", "11:03", "12:18", "13:18", "14:18", "15:23", "16:28", "17:18", "17:48", "18:28", "19:13", "20:03", "21:06", "22:16", "22:48"];

        // Station coordinates
        const SerdangKTMStation = [3.023277436768209, 101.71580855814486];
        const MVKTMStation = [3.118741643119998, 101.67891120835036];

        // Initialize the map at the current location
        const map = L.map('map').setView([3.0232, 101.716], 12);

        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
        }).addTo(map);

        // Function to determine marker color based on vehicle ID (even or odd)
        function getMarkerColor(vehicleId) {
            const idNumber = parseInt(vehicleId.replace('weekday_', ''), 10);
            return idNumber % 2 === 0 ? 'blue' : 'red';
        }

        // Haversine formula to calculate distance between two coordinates in km
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the Earth in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in kilometers
        }

        // Function to plot vehicles on the map
        function plotVehicles(vehicles) {
            // Clear existing markers
            map.eachLayer(layer => {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });

            vehicles.forEach(vehicle => {
                const { latitude, longitude } = vehicle.position;
                const vehicleId = vehicle.vehicle.id;

                console.log(`Plotting Vehicle: ${vehicleId}, Position: (${latitude}, ${longitude})`);

                // Determine the distance from the correct station based on vehicle ID
                const idNumber = parseInt(vehicleId.replace('weekday_', ''), 10);
                let distance;
                let departureTime;
                
                if (MVVehicleId.includes(vehicleId)) {
                    // MVVehicleId: calculate distance from MVKTMStation
                    distance = calculateDistance(latitude, longitude, MVKTMStation[0], MVKTMStation[1]);
                    departureTime = MVDepartureTime[MVVehicleId.indexOf(vehicleId)];
                } else if (SerdangVehicleId.includes(vehicleId)) {
                    // SerdangVehicleId: calculate distance from SerdangKTMStation
                    distance = calculateDistance(latitude, longitude, SerdangKTMStation[0], SerdangKTMStation[1]);
                    departureTime = SerdangDepartureTime[SerdangVehicleId.indexOf(vehicleId)];
                } else {
                    distance = 0;
                    departureTime = "Unknown";
                }

                // Round distance to 2 decimal places
                distance = distance.toFixed(2);

                // Create a marker with an arrow icon based on even/odd vehicle ID
                const arrowIcon = L.divIcon({
                    html: idNumber % 2 === 0 
                        ? '<div style="font-size: 24px; color: blue;">&#x1F881;</div>'  // Upward arrow ü¢Å for even vehicle ID
                        : '<div style="font-size: 24px; color: red;">&#x1F883;</div>',   // Downward arrow ü¢É for odd vehicle ID
                    className: 'vehicle-arrow-icon',
                    iconSize: [24, 24], // Adjust size as needed
                    iconAnchor: [12, 12] // Center the icon
                });

                const marker = L.marker([latitude, longitude], {
                    icon: arrowIcon
                }).addTo(map);

                // Show the vehicle ID, distance, and departure time as a label
                const numericId = vehicleId.replace('weekday_', ''); // Extract numeric part of vehicleId
                const label = `${departureTime} - ${distance} km ( #${numericId})`;
                
                marker.bindTooltip(label, {
                    permanent: true,   // Tooltip is always visible
                    direction: 'top',  // Display tooltip above the marker
                    offset: [0, -10],  // Offset the tooltip for better visibility
                    className: 'vehicle-label' // Optional: custom class for styling
                });
            });
        }

        // Function to fetch data from the API
        async function fetchData() {
            try {
                const response = await fetch('https://api.mtrec.name.my/api/position?agency=ktmb');
                const data = await response.json();

                // Log the complete response to understand its structure
                console.log('API Response:', data);

                // Access the correct structure if data is wrapped in an object
                const vehicles = data.data || []; // assuming the actual array is inside 'data' key

                // Log vehicle IDs and positions for debugging
                vehicles.forEach(vehicle => {
                    const vehicleId = vehicle.vehicle.id;
                    const { latitude, longitude } = vehicle.position;
                    console.log(`Vehicle ID: ${vehicleId}, Latitude: ${latitude}, Longitude: ${longitude}`);
                });

                // Plot the vehicles on the map
                plotVehicles(vehicles);

            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        // Function to get the current location and set the map's view
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const { latitude, longitude } = position.coords;
                    map.setView([latitude, longitude], 12); // Set the map view to current location
                    fetchData(); // Fetch data when location is obtained
                }, () => {
                    // Fallback to default location if geolocation fails
                    console.error('Geolocation failed. Using default location.');
                    fetchData(); // Fetch data with default location
                });
            } else {
                console.error('Geolocation is not supported by this browser.');
                fetchData(); // Fetch data with default location
            }
        }

        // Call the function to get the current location on page load
        getCurrentLocation();

        // Refresh data every 10 seconds
        setInterval(() => {
            fetchData();
        }, 10000);

    </script>
</body>
</html>
